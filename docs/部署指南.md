# XJTLU Quiz Helper 部署指南

把产品部署到公网后，任何人（包括中国用户）都可以通过链接访问使用。下面提供几种常见方式，按「中国用户访问体验」从好到一般排序。

---

## 一、部署方式概览

| 方式 | 中国用户访问 | 难度 | 备案 | 说明 |
|------|----------------|------|------|------|
| **国内云 / 香港服务器** | 最好 | 中 | 国内需备案 | 阿里云、腾讯云、华为云等，或香港 VPS |
| **Railway / Render** | 一般（可能需代理） | 低 | 不需要 | 海外平台，一键部署，国内有时慢或需科学上网 |
| **Vercel + 后端单独部署** | 一般 | 中 | 不需要 | 前端 CDN，后端需另选（如 Railway） |

推荐：**希望中国用户直接打开就用** → 优先选 **香港或国内云**；**先快速上线、用户可接受海外站点** → 用 **Railway 或 Render**。

---

## 二、通用准备（所有方式都要做）

### 1. 本地先能跑通

在项目根目录执行：

```bash
npm run install:all
npm run build
npm run start
```

再设置生产环境变量后启动：

- **Windows PowerShell**：`$env:NODE_ENV="production"; node server/index.js`
- **Linux / Mac / Railway / Render**：`NODE_ENV=production node server/index.js`（或使用根目录脚本 `npm run start:prod`，需在支持该语法的环境中运行）

浏览器访问 `http://localhost:5000`，应能看到登录页且接口正常。

### 2. 生产环境变量（必改）

在部署平台或服务器上配置环境变量（名字与下面一致）：

| 变量名 | 必填 | 说明 |
|--------|------|------|
| `NODE_ENV` | 是 | 填 `production` |
| `JWT_SECRET` | 是 | 随机长字符串（如 32 位），不要用默认值 |
| `PORT` | 否 | 端口，多数平台自动分配 |
| `DATABASE_PATH` | 否 | 持久化数据库路径（见下） |
| `FRONTEND_URL` | 否 | 仅前后端分离时填前端域名 |
| `SMTP_*` | 否 | 需要真实发邮件时再配 |

说明：

- **数据库**：部署在 Railway/Render 等时，实例重启可能清空本地磁盘，需用平台提供的「持久化卷」并把 `DATABASE_PATH` 指到卷内路径（如 `/data/quiz.db`）。否则仅适合演示。
- **邮件**：不配 SMTP 时，提醒逻辑仍会跑，只是不发真实邮件（控制台打印）。

### 3. 构建与启动命令（推荐）

部署时在「构建」阶段执行：

```bash
npm run install:all
npm run build
```

在「启动」阶段执行（从项目根目录）：

```bash
NODE_ENV=production node server/index.js
```

若平台自动设 `NODE_ENV=production`，则只需：

```bash
node server/index.js
```

生产环境下，后端会托管前端构建产物（`client/dist`），用户只访问一个域名即可（例如 `https://你的应用域名`）。

---

## 三、方式 A：Railway 部署（海外，上手最快）

适合：先上线、不要求国内直连。

1. 打开 [Railway](https://railway.app)，用 GitHub 登录。
2. 新建项目 → **Deploy from GitHub repo**，选择本项目的仓库。
3. 在项目设置里配置：
   - **Build Command**：`npm run install:all && npm run build`
   - **Start Command**：`npm run start:prod` 或 `NODE_ENV=production node server/index.js`
   - **Root Directory**：留空（仓库根目录）。
4. 在 **Variables** 里添加：`NODE_ENV=production`、`JWT_SECRET=<你的随机密钥>`。
5. 如需持久化数据库：在 Railway 里添加 **Volume**，挂载到例如 `/data`，再增加变量 `DATABASE_PATH=/data/quiz.db`。
6. 部署完成后，Railway 会给出一个 `*.railway.app` 的域名，点开即可使用。

中国用户：部分地区可能较慢或需代理才能稳定访问。

---

## 四、方式 B：Render 部署（海外）

1. 打开 [Render](https://render.com)，用 GitHub 登录。
2. **New → Web Service**，选仓库。
3. 配置：
   - **Build Command**：`npm run install:all && npm run build`
   - **Start Command**：`npm run start:prod` 或 `NODE_ENV=production node server/index.js`
4. 在 **Environment** 里添加 `NODE_ENV`、`JWT_SECRET` 等。
5. Render 免费实例会在一段时间无访问后休眠，再次访问时会冷启动几秒到几十秒。

中国用户：同上，可能较慢或需代理。

---

## 五、方式 C：国内 / 香港服务器（中国用户访问最佳）

适合：希望中国用户直接打开、延迟低。

### 1. 买一台服务器

- **香港**：阿里云国际、腾讯云、Vultr、Bandwagon 等，一般不需要备案。
- **大陆**：阿里云、腾讯云、华为云等，若用国内节点并对外提供 HTTP(S) 服务，需要 **ICP 备案**。

### 2. 安装 Node.js

例如 Ubuntu：

```bash
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs
```

### 3. 上传代码并安装依赖

用 Git 或 SCP 把项目放到服务器，例如 `/var/www/xjtlu-quiz-helper`，然后：

```bash
cd /var/www/xjtlu-quiz-helper
npm run install:all
npm run build
```

### 4. 配置环境变量并启动

创建 `server/.env`（或系统环境变量），至少包含：

```env
NODE_ENV=production
JWT_SECRET=你的随机长密钥
PORT=5000
```

启动方式（二选一）：

- 直接前台运行（测试用）：
  ```bash
  NODE_ENV=production node server/index.js
  ```
- 用 **PM2** 常驻（推荐）：
  ```bash
  npm install -g pm2
  cd /var/www/xjtlu-quiz-helper
  NODE_ENV=production pm2 start server/index.js --name quiz-helper
  pm2 save && pm2 startup
  ```

### 5. 用 Nginx 做反向代理（可选但推荐）

这样可以用 80/443 端口、挂域名、上 HTTPS。示例 Nginx 配置（替换成你的域名和端口）：

```nginx
server {
    listen 80;
    server_name 你的域名.com;

    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

然后：

```bash
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d 你的域名.com
```

即可获得 HTTPS。用户访问 `https://你的域名.com` 即可使用。

### 6. 数据库持久化

服务器重启后数据要保留的话，不要把数据库放在临时目录。可设：

```env
DATABASE_PATH=/var/www/xjtlu-quiz-helper/data/quiz.db
```

并保证该目录存在且进程有写权限。

---

## 六、部署后如何「让任何人点击使用」

1. **拿到访问地址**  
   - Railway/Render：使用平台给的域名（如 `https://xxx.railway.app`）。  
   - 自建服务器：使用你配置的域名（如 `https://quiz.你的域名.com`）。

2. **把链接发给用户**  
   直接把该 URL 发给同学/朋友，他们用浏览器打开即可。中国用户：
   - 若部署在 **香港或国内**：一般直接打开即可。
   - 若部署在 **海外**（Railway/Render）：部分网络可能较慢或需代理。

3. **使用方式不变**  
   用户打开链接 → 使用 XJTLU 邮箱 + 验证码登录 → 使用主页、课程表、邮件记录等功能。验证码仍在**服务器控制台**打印（除非你后续接入真实邮件/短信）。

---

## 七、常见问题

- **部署后打开是空白页**  
  检查：是否执行了 `npm run build`；`NODE_ENV` 是否为 `production`；平台是否从**项目根目录**执行 start 命令（这样才能找到 `server/index.js` 和 `client/dist`）。

- **接口 404 或 CORS 报错**  
  当前默认是「后端托管前端」同一域名，一般不会有 CORS 问题。若你改成前后端分离（前端单独部署），需在后台设置 `FRONTEND_URL=https://你的前端域名`，且前端构建时设置 `VITE_API_BASE_URL=https://你的后端域名/api`。

- **中国用户打不开或很慢**  
  优先考虑把服务部署到 **香港或国内**（并按要求备案），或换一家对国内线路更友好的海外主机。

- **数据库重启后丢了**  
  在 Railway/Render 等使用「持久化卷」并把 `DATABASE_PATH` 指到卷内；在自建服务器上把 `DATABASE_PATH` 指到非临时目录。

按上述任选一种方式部署后，把最终访问链接发给用户，即可让任何人点击使用；中国用户体验最好的是国内/香港服务器方案。
