# 持久稳定与运维指南

本文档说明如何让产品**持久稳定运行**、**长期服务几十位用户**、**支持持续迭代**，以及**管理后台**的使用方法。

---

## 一、持久稳定运行

### 1. 数据库持久化（必做）

**问题**：默认数据库在 `server/data/quiz.db`，若应用目录被替换，数据会丢失。

**做法**：将数据库放到应用目录外。

```bash
# 首次部署或迁移前执行
mkdir -p /data
```

在 `server/.env` 中设置：

```
DATABASE_PATH=/data/quiz.db
```

若已有数据在 `server/data/quiz.db`，需先迁移：

```bash
pm2 stop quiz-helper
cp -a /var/www/quiz-helper/server/data/quiz.db /data/quiz.db
echo "DATABASE_PATH=/data/quiz.db" >> /var/www/quiz-helper/server/.env
pm2 start quiz-helper
```

### 2. 进程管理（PM2）

- 使用 PM2 启动：`pm2 start server/index.js --name quiz-helper`
- 开机自启：`pm2 startup` 执行后按提示操作
- 监控：`pm2 status`、`pm2 logs quiz-helper`

### 3. 健康检查

- 服务提供 `/api/health` 接口，可配置监控或负载均衡探测
- 返回 `{ ok: true }` 表示服务正常

### 4. 定期备份（建议）

```bash
# 每日备份数据库（可使用 crontab）
sqlite3 /data/quiz.db ".backup /data/backup/quiz_$(date +%Y%m%d).db"
```

---

## 二、长期服务几十位用户

| 项目 | 说明 |
|------|------|
| **数据库** | SQLite 在几十用户场景下足够，单机即可 |
| **邮件** | 需配置 SMTP（学校邮箱、SendGrid 等），否则仅控制台打印 |
| **并发** | 单实例可满足，若将来扩展可考虑多实例 + 共享数据库（PostgreSQL） |
| **资源** | 1 核 2G 即可，建议定期查看 `pm2 monit` |

---

## 三、持久迭代（更新不丢数据）

**正确更新流程**：

```bash
cd /var/www/quiz-helper
git pull
npm run install:all
NODE_ENV=development npm run build
pm2 restart quiz-helper
```

**注意**：
- 使用 `git pull` 在同一目录更新，不要 `rm -rf` 后重新 clone
- 已设置 `DATABASE_PATH=/data/quiz.db` 时，数据与代码分离，更新不会影响数据

---

## 四、管理后台

### 功能

- 查看注册用户列表（邮箱、注册时间、课程数、发送邮件数）
- 查看邮件发送统计（总数、按用户汇总）
- 向所有注册用户群发通知邮件

### 配置管理员

在 `server/.env` 中设置：

```
ADMIN_EMAILS=你的邮箱@xjtlu.edu.cn,另一个管理员@xjtlu.edu.cn
```

多个管理员用逗号分隔，邮箱需为 `xjtlu.edu.cn` 域名。

### 使用方式

1. 使用管理员邮箱登录
2. 顶部导航出现「管理后台」
3. 进入后可查看用户与邮件统计，并可发送群发通知

### 安全说明

- 仅 `ADMIN_EMAILS` 中的邮箱可访问管理接口
- 未配置时，任何人无法访问管理后台
- 群发邮件会记录到 `email_logs` 表
