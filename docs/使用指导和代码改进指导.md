# XJTLU Quiz Helper：使用指导与代码改进指导

本文档包含：**一、产品使用指导**；**二、国内服务器部署方案（可完全跑通）**；**三、代码改进与扩展指导**（含验证码开关、环境变量、结构说明）。

---

# 一、产品使用指导

## 1.1 谁可以用

仅支持 **@xjtlu.edu.cn** 邮箱（含子域如 student.xjtlu.edu.cn）登录使用。

## 1.2 登录

- 当前默认：**仅需填写邮箱即可登录**（验证码已暂时隐藏，便于内测/演示）。
- 打开部署后的链接 → 输入 XJTLU 邮箱 → 点击「登录」即可进入。

## 1.3 主页（课程管理）

- **手动录入**：添加课程、选择星期、开始/结束时间、是否开启 Quiz 提醒（圆点图标），点击「保存（n）」保存未保存项。
- **导出课表**：点击「导出课表」可下载当前课程列表为 CSV。
- **按时间排序**：列表默认按星期+时间排序，可再次点击「按时间排序」重排。
- 有未保存修改时切到「课程表」或「邮件记录」会弹出离开确认；保存后课程表页会刷新。

## 1.4 课程表

- 上午/下午 × 周一至周日网格展示；无课格留空。
- 每门课显示三种状态之一：**不提醒**（灰）、**已提醒**（绿）、**待提醒**（黄），依据「本周是否已发过提醒」计算。

## 1.5 邮件记录

- 按年/月汇总发送记录；可「导出 CSV」、可「发送测试邮件」（需后端配置 SMTP 后才有真实发信）。

---

# 二、国内服务器部署方案（可完全跑通）

以下为**付费国内/香港云服务器**部署方案，按步骤执行即可在公网跑通，中国用户可直接访问。若选**大陆节点**需完成 ICP 备案；选**香港节点**一般免备案。

## 2.1 方案概览

| 项目 | 说明 |
|------|------|
| 推荐平台 | 阿里云 ECS / 腾讯云轻量应用服务器（国内或香港） |
| 系统 | Ubuntu 22.04 LTS（或 20.04） |
| 技术栈 | Node.js + PM2 + Nginx + 可选 HTTPS（Let's Encrypt 或云厂商证书） |
| 备案 | 大陆服务器对外提供 HTTP/HTTPS 需 ICP 备案；香港免备案 |

## 2.2 购买与准备服务器

1. **阿里云**：进入 [阿里云 ECS](https://www.aliyun.com/product/ecs)，选择地域（大陆需备案，香港免备案）、镜像选 Ubuntu 22.04，按量付费或包年包月均可；记录公网 IP。
2. **腾讯云**：进入 [轻量应用服务器](https://cloud.tencent.com/product/lighthouse)，同样选地域与 Ubuntu 22.04，购买后获得公网 IP。
3. **安全组/防火墙**：放行 **22（SSH）、80（HTTP）、443（HTTPS）**。应用内部监听端口（如下述 5000）仅本机访问，可不对外开放。

## 2.3 连接服务器并安装环境

使用 SSH 连接（替换为你的 IP 和用户名）：

```bash
ssh root@你的公网IP
```

安装 Node.js（建议 LTS，如 20.x）、Git、Nginx：

```bash
# 更新系统
apt update && apt upgrade -y

# 安装 Node.js 20（使用 NodeSource）
curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
apt install -y nodejs

# 验证
node -v   # 应显示 v20.x
npm -v

# 安装 Git、Nginx
apt install -y git nginx
```

## 2.4 上传代码并构建

在服务器上创建目录并拉取或上传项目（示例用 Git；也可用 SCP 上传压缩包后解压）：

```bash
# 若用 Git（请替换为你的仓库地址）
cd /var
mkdir -p www && cd www
git clone https://github.com/你的用户名/xjtlu-quiz-helper.git
cd xjtlu-quiz-helper

# 或：本地上传后解压到 /var/www/xjtlu-quiz-helper
```

安装依赖并构建前端：

```bash
cd /var/www/xjtlu-quiz-helper
npm run install:all
npm run build
```

确认存在 `client/dist` 目录且 `server/index.js` 在项目内。

## 2.5 配置环境变量

在服务器上创建 `server/.env`（不要提交到 Git）：

```bash
nano /var/www/xjtlu-quiz-helper/server/.env
```

写入以下内容（按需修改）：

```env
NODE_ENV=production
PORT=5000
JWT_SECRET=请替换为至少32位随机字符串
# 可选：数据库持久化路径（默认在 server/data/quiz.db）
# DATABASE_PATH=/var/www/xjtlu-quiz-helper/data/quiz.db
# 可选：SMTP 发邮件（不配则仅控制台打印）
# SMTP_HOST=smtp.example.com
# SMTP_PORT=587
# SMTP_USER=...
# SMTP_PASS=...
# SMTP_FROM=...
```

保存退出。当前默认**未启用验证码**，无需配置 `ENABLE_EMAIL_VERIFICATION`。

## 2.6 使用 PM2 常驻进程

安装 PM2 并启动应用（从**项目根目录**启动，以便正确找到 `client/dist`）：

```bash
npm install -g pm2
cd /var/www/xjtlu-quiz-helper
pm2 start server/index.js --name quiz-helper
pm2 save
pm2 startup
# 按提示执行最后一行命令，保证重启后自启
```

检查状态与日志：

```bash
pm2 status
pm2 logs quiz-helper
```

此时本机访问 `http://127.0.0.1:5000` 应能看到登录页。若安全组未开放 5000，外网仍不能直接访问，下一步用 Nginx 反向代理到 80/443。

## 2.7 配置 Nginx 反向代理（必做，便于用域名与 HTTPS）

创建站点配置（将 `你的域名.com` 换成实际域名或暂时用服务器公网 IP 访问则用 `_` 或默认）：

```bash
nano /etc/nginx/sites-available/quiz-helper
```

写入：

```nginx
server {
    listen 80;
    server_name 你的域名.com;   # 无域名可先填 _ 或服务器公网 IP

    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

启用站点并重载 Nginx：

```bash
ln -sf /etc/nginx/sites-available/quiz-helper /etc/nginx/sites-enabled/
nginx -t && systemctl reload nginx
```

- 若用**域名**：在域名服务商处将 A 记录指向服务器公网 IP；大陆服务器需先完成 ICP 备案再解析。
- 若暂时无域名：可将 `server_name` 改为 `_` 或本机公网 IP，然后通过 `http://公网IP` 访问。

## 2.8 配置 HTTPS（推荐）

使用 Let's Encrypt 免费证书（需已解析到该服务器的域名）：

```bash
apt install -y certbot python3-certbot-nginx
certbot --nginx -d 你的域名.com
```

按提示选择为上述 Nginx 站点配置 HTTPS。配置完成后用户应使用 `https://你的域名.com` 访问。

## 2.9 部署后验证

1. 浏览器打开 `https://你的域名.com`（或 `http://公网IP`）。
2. 输入任意 @xjtlu.edu.cn 邮箱，点击「登录」，应能进入主页。
3. 添加课程、保存、切到课程表与邮件记录，确认功能正常。

至此国内服务器方案即可**完全跑通**。若选大陆节点，备案通过后再将域名解析到该服务器即可。

---

# 三、代码改进指导

## 3.1 项目结构概览

```
xjtlu-quiz-helper/
├── client/                 # 前端（Vite + React）
│   ├── src/
│   │   ├── api/client.js   # API 封装与 baseURL
│   │   ├── context/        # Toast 等
│   │   ├── views/          # 各页面：LoginView, HomeView, ScheduleView, EmailRecordsView
│   │   └── lib/utils.js    # 工具与排序等
│   └── .env.example        # 前端环境变量示例（VITE_*）
├── server/
│   ├── index.js            # Express 入口，生产时托管 client/dist
│   ├── routes/             # auth, courses, emailLogs
│   ├── database/db.js      # SQLite 路径可配置
│   ├── services/scheduler.js  # 课前提醒定时任务
│   └── .env / .env.example # 后端环境变量
└── docs/                    # 部署指南、本使用与改进指导等
```

## 3.2 环境变量一览

**后端（server/.env）**

| 变量 | 必填 | 说明 |
|------|------|------|
| `NODE_ENV` | 生产必填 | `production` 时托管前端并启用生产行为 |
| `JWT_SECRET` | 必填 | 生产环境务必改为随机长字符串 |
| `PORT` | 否 | 默认 5000 |
| `DATABASE_PATH` / `DATABASE_DIR` | 否 | SQLite 路径，不设则用 server/data/quiz.db |
| `ENABLE_EMAIL_VERIFICATION` | 否 | 设为 `true` 时启用验证码登录（见下） |
| `FRONTEND_URL` | 否 | 前后端分离时填前端域名（CORS） |
| `SMTP_*` | 否 | 真实发邮件时配置 |

**前端（client/.env，构建时生效）**

| 变量 | 说明 |
|------|------|
| `VITE_ENABLE_EMAIL_VERIFICATION` | `true` 时显示验证码输入与「获取验证码」 |
| `VITE_API_BASE_URL` | 前后端分离时填后端 API 地址，如 `https://api.xxx.com/api` |

## 3.3 验证码：暂时隐藏与未来启用

当前逻辑：

- **后端**：未设置 `ENABLE_EMAIL_VERIFICATION=true` 时，`/auth/login` 仅校验邮箱，不校验验证码，直接发 JWT。
- **前端**：未设置 `VITE_ENABLE_EMAIL_VERIFICATION=true` 时，登录页只显示邮箱输入框和「登录」按钮，不显示验证码输入和「获取验证码」。

**未来要重新启用验证码时：**

1. **后端**：在 `server/.env` 中增加或修改为：
   ```env
   ENABLE_EMAIL_VERIFICATION=true
   ```
2. **前端**：在 `client/.env` 中增加：
   ```env
   VITE_ENABLE_EMAIL_VERIFICATION=true
   ```
3. 重新构建并重启：
   ```bash
   npm run build
   pm2 restart quiz-helper
   ```

代码中已用注释标出「未来启用验证码」的位置：

- **server/routes/auth.js**：顶部 `ENABLE_EMAIL_VERIFICATION` 说明；`login` 中「未来启用验证码」整段校验逻辑。
- **client/src/views/LoginView.jsx**：顶部 `ENABLE_EMAIL_VERIFICATION` 说明；验证码输入框与「获取验证码」按钮处的注释。

## 3.4 可扩展点与注意事项

- **验证码存储**：当前为内存 Map，重启即清空；生产启用验证码时建议改为 Redis 等持久化存储。
- **数据库**：SQLite 适合单机；若多实例部署需共享数据库，可改为 PostgreSQL/MySQL 并改 `server/database/db.js`。
- **邮件**：未配置 SMTP 时，提醒逻辑仍会执行，仅控制台打印；配置后课前 5 分钟会真实发信（见 `server/services/scheduler.js`）。
- **静态与 API**：生产环境下 Express 先提供 `/api`，再托管 `client/dist` 并做 SPA 回退，因此同一域名下无需再配 CORS；仅在前后端分离部署时需设置 `FRONTEND_URL` 与 `VITE_API_BASE_URL`。

## 3.5 构建与启动命令速查

```bash
# 安装依赖
npm run install:all

# 构建前端（产出 client/dist）
npm run build

# 开发
npm run dev

# 生产启动（从项目根目录）
NODE_ENV=production node server/index.js
# 或使用 PM2
pm2 start server/index.js --name quiz-helper
```

按本文「二、国内服务器部署方案」操作即可在国内服务器上完全跑通；按「三、代码改进指导」可维护、扩展或重新启用验证码。
